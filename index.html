<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DASHBOARD POTENSI JASA KONSTRUKSI</title>
    <title>KANTOR CABANG MEDAN KOTA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #004c99; /* Biru BPJS */
            --color-secondary: #0066cc; /* Biru Terang */
            --color-green: #28a745;    /* Hijau Awal */
            --color-yellow-accent: #ffc107; /* Kuning (untuk highlight/warning) */
            --color-background: #f0f3f6; /* Abu-abu Muda */
            --color-surface: #ffffff; /* Putih */
            --color-text-dark: #333333;
            --color-text-light: #ffffff;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); /* Shadow lebih kecil */
            --border-radius: 8px; /* Radius lebih kecil */
            --font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--color-background);
            color: var(--color-text-dark);
            min-height: 100vh;
            padding: 10px; 
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            margin: 0;
        }
        
        .container {
            max-width: 1200px; 
            margin: 0 auto;
            flex-grow: 1;
            background: var(--color-surface);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 15px; 
            display: flex;
            flex-direction: column;
            gap: 10px; 
            height: calc(100vh - 20px);
            overflow: hidden;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--color-surface);
            padding: 5px 0; 
            border-bottom: 1px solid #e0e0e0; 
        }

        .header-section {
            display: flex;
            align-items: center;
        }

        .header-logo {
            height: 70px;
            margin-right: 8px;
            border-radius: 6px;
        }
            
        .header-logo:last-of-type {
            margin-right: 0;
        }

        .header-title {
            text-align: center;
            flex-grow: 1;
        }
            
        .header-title h1 {
            font-size: 1.1rem; 
            color: var(--color-primary);
            font-weight: 700;
            margin-bottom: 3px;
        }
            
        .header-title p {
            font-size: 0.8rem; 
            font-weight: 500;
            color: #000000;
            font-style: italic;
        }

        .header-person {
            height: 35px; 
            margin-left: 10px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #008000;
            color: var(--color-text-light);
            padding: 8px 15px;
            margin-bottom: 5px; 
            font-weight: 500;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            font-size: 1em; 
        }
            
        .top-bar-left {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 700;
        }

        .top-bar-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
        }

        .nav-button {
            display: inline-block;
            margin: 0 5px; 
            padding: 6px 15px; 
            font-size: 0.9em;
            color: var(--color-primary);
            background-color: var(--color-surface);
            border-radius: 6px;
            text-decoration: none;
            font-weight: bold;
            transition: background 0.3s;
        }

        .nav-button:hover {
            background-color: #e9eef2;
        }
        
        .status-indicator {
            margin-left: 15px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8em;
        }
        .status-loading { background-color: var(--color-yellow-accent); color: var(--color-text-dark); }
        .status-online { background-color: #00b894; color: var(--color-text-light); }
        .status-error { background-color: #d63031; color: var(--color-text-light); }

        h2 {
            font-size: 1.2rem; 
            font-weight: 700;
            margin-bottom: 10px; 
            color: var(--color-primary);
            text-align: center;
        }
            
        .panel {
            background-color: var(--color-surface);
            padding: 15px;
            border: 1px solid #edf2f7;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            flex-grow: 1;
            overflow: hidden;
        }

        .dashboard {
            display: grid;
            grid-template-areas:  
                "summary table"
                "charts table"; 
            grid-template-columns: 55% 45%;
            grid-template-rows: auto 1fr; 
            gap: 5px 10px; 
            flex-grow: 1;
            height: calc(100vh - 200px);
            padding-bottom: 0; 
            overflow: hidden;
        }
            
        .summary-area { 
            grid-area: summary; 
            padding: 10px; 
            height: 100%;
            display: flex;
            flex-direction: column;
        } 
        
        .charts-area { 
            grid-area: charts; 
            padding: 10px; 
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px; 
            overflow-y: hidden; 
            margin-bottom: 0 !important; 
        } 
        
        .table-area { 
            grid-area: table; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            padding: 10px; 
            margin-bottom: 0 !important;
            height: 100%;
        }
        
        .summary-cards-wrapper { 
            display: flex;
            flex-direction: column;
            gap: 5px; 
            height: 100%;
        }

        .summary-cards-wrapper h2 {
            margin-bottom: 5px;
            text-align: left;
            padding-left: 5px;
            font-size: 1rem; 
        }

        .summary-cards {
            display: flex; 
            flex-wrap: nowrap;
            justify-content: space-between;
            gap: 5px; 
            height: 100%;
        }
            
        .summary-cards .card {
            width: calc(33.333% - 4px); 
            min-width: 90px; 
            padding: 8px 4px; 
            text-align: center;
            align-items: center;
            height: 70px; 
            justify-content: center; 
        }

        .summary-cards .card h3 {
            font-size: 0.65rem; 
            font-weight: 500;
            margin: 0 0 2px 0; 
            line-height: 1.1; 
            opacity: 0.9;
            text-align: center;
            white-space: normal; 
        }

        .summary-cards .card .value {
            font-size: 1.3rem; 
            font-weight: 700;
            margin: 1px 0;
            line-height: 1.1; 
            text-align: center;
            overflow: hidden; 
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .summary-cards .card .currency {
            font-size: 0.7rem;
            line-height: 1.1;
        }

        /* ============================= */
        /* CHART AREA - IMPROVED LAYOUT */
        /* ============================= */

        .charts-container {
            display: flex;
            flex-direction: column;
            gap: 6px;
            height: 100%;
            overflow: hidden;
        }

        .chart-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: transparent;
            border: none;
            padding: 0;
            height: 50%;
            min-height: 250px;
        }

        .chart-card h3 {
            font-size: 0.9rem;
            margin: 0 0 4px 4px;
            color: var(--color-primary);
            font-weight: 700;
        }

        .chart-container {
            position: relative;
            height: 100%;
            flex-grow: 1;
            display: flex;
        }

        /* Chart + detail berdampingan */
        .chart-with-details {
            display: flex;
            align-items: stretch;
            justify-content: space-between;
            height: calc(100% - 22px);
            gap: 8px;
        }

        .chart-wrapper {
            flex: 1;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 0; /* Penting untuk mencegah overflow */
        }

        /* Panel rincian - IMPROVED */
        .chart-details {
            width: 300px;
            border-radius: 12px;
            padding: 12px;
            background: #ffffff;
            border: 1px solid #e1e5e9;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            font-size: 0.8rem;
            overflow-y: auto;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chart-details h4 {
            text-align: center;
            color: var(--color-primary);
            font-weight: 700;
            margin: 0 0 8px 0;
            font-size: 0.9rem;
            padding-bottom: 8px;
            border-bottom: 1px solid #e1e5e9;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
        }

        /* Item detail dalam kotak terpisah yang rapi */
        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-radius: 8px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
            min-height: 50px;
        }

        .detail-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        /* Warna border kiri sesuai kategori */
        .detail-item.red { 
            border-left: 4px solid #ef4444;
            background: linear-gradient(to right, #fef2f2, #f8fafc);
        }
        .detail-item.blue { 
            border-left: 4px solid #1d4ed8;
            background: linear-gradient(to right, #eff6ff, #f8fafc);
        }
        .detail-item.dark { 
            border-left: 4px solid #0f172a;
            background: linear-gradient(to right, #f1f5f9, #f8fafc);
        }

        /* Container untuk label dan nilai */
        .detail-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .detail-label {
            color: #374151;
            font-weight: 600;
            font-size: 0.8rem;
            flex: 1;
        }

        .detail-values {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        .detail-value {
            font-weight: 700;
            font-size: 0.85rem;
            color: #1f2937;
        }

        .detail-percent {
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
        }

        /* NEW: Iuran styling - sama dengan persen */
        .detail-iuran {
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
        }

        /* Style untuk Tabel */
        .table-area h2 {
            text-align: left;
            margin-bottom: 5px;
            padding: 0 5px;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--color-primary);
        }

        .data-table-container {
            height: calc(100% - 40px);
            max-height: none;
            overflow-y: auto;
            overflow-x: auto;
            flex-grow: 1;
            padding-bottom: 0;
            border-radius: var(--border-radius);
            border: 1px solid #edf2f7;
        }
        
        .table-area.panel {
            padding: 0;
            border: none;
            box-shadow: none;
            height: 100%;
        }

        .data-table thead th {
            position: sticky;
            top: 0;
            z-index: 15;
            padding: 8px 6px;
            font-size: 0.75rem;
            text-align: center;
            line-height: 1.1;
            background: linear-gradient(135deg, var(--color-primary), #0056b3);
            color: var(--color-text-light);
            font-weight: 600;
            white-space: normal;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border: 1px solid #003a73;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .data-table th:first-child, .data-table td:first-child {
            text-align: center;
        }
        
        .center-text {
            text-align: center !important;
        }
        
        .data-table td {
            padding: 4px 6px;
            font-size: 0.8rem;
            text-align: left;
            border-bottom: 1px solid #edf2f7;
            min-height: 35px;
            height: 35px;
        }
            
        .data-table { 
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed; 
        }
        
        .data-table th:nth-child(1), .data-table td:nth-child(1) { 
            width: 8%;
        }

        .data-table th:nth-child(2), .data-table td:nth-child(2) { 
            width: 65%;
        }

        .data-table th:nth-child(3), .data-table td:nth-child(3) { 
            width: 15%;
        }

        .data-table tr:nth-child(even) { 
            background-color: #f8fafc; 
        }

        
        .card {
            background-color: var(--color-surface);
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            text-align: center;
            color: var(--color-text-light);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-grow: 1; 
        }
        
        .card.total-projects { background: linear-gradient(135deg, var(--color-green), #20c997); }
        .card.total-value { background: linear-gradient(135deg, var(--color-primary), #0056b3); }
        .card.avg-value { background: linear-gradient(135deg, var(--color-secondary), #0052cc); }
        
        .instansi-link { 
            color: var(--color-secondary); 
            font-weight: 500; 
            text-decoration: none; 
            display: block; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
        }

        .main-footer {
            background: linear-gradient(135deg, var(--color-green), #20c997);
            color: var(--color-text-light);
            padding: 8px 15px;
            font-size: 0.9em;
            text-align: right;
            margin-top: 5px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            font-weight: 500;
        }
        
        .footer-text {
            margin: 0;
            line-height: 1.4;
        }

        /* ================== Media Queries untuk Responsif ================== */
        @media (max-width: 900px) {
            .dashboard {
                grid-template-areas:  
                    "summary"
                    "charts"
                    "table";
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr;
                height: auto;
            }
            
            .container {
                padding: 8px;
                height: auto;
            }
            
            header {
                flex-direction: column;
                gap: 8px;
            }
            
            .top-bar {
                flex-direction: column;
                gap: 6px;
                padding: 6px 10px;
            }
            
            .summary-cards {
                flex-wrap: wrap;
            }
            
            .summary-cards .card {
                width: calc(50% - 3px);
                margin-bottom: 5px;
            }
            
            .charts-area {
                height: auto;
                min-height: 600px;
            }
            
            .chart-card {
                height: auto;
                min-height: 300px;
                margin-bottom: 15px;
            }
            
            .chart-card:last-child {
                margin-bottom: 0;
            }
            
            .data-table-container {
                max-height: 300px;
            }
            
            .main-footer {
                padding: 6px 10px;
                font-size: 0.75rem;
                text-align: center;
            }
            
             .chart-details {
        width: 40%; /* Lebar lebih kecil untuk mobile */
        height: auto;
        order: 2; /* Tetap di posisi 2 (kanan) */
        max-height: none; /* Hapus max-height */
    }
    
    .chart-wrapper {
        width: 60%; /* Chart lebih lebar */
        order: 1; /* Tetap di posisi 1 (kiri) */
        height: 250px; /* Tinggi tetap */
        min-height: 250px;
    }
    
    .detail-item {
        padding: 8px 10px; /* Padding lebih kecil */
        min-height: 40px; /* Tinggi lebih kecil */
    }
    
    .detail-label {
        font-size: 0.75rem; /* Font lebih kecil */
    }
    
    .detail-value {
        font-size: 0.8rem;
    }
    
    .detail-iuran,
    .detail-percent {
        font-size: 0.7rem; /* Font lebih kecil untuk iuran dan persen */
    }
}

        @media (max-width: 520px) {
            .summary-cards .card {
                width: 100%;
            }
            
            .header-title h1 {
                font-size: 0.9rem;
            }
            
            .header-title p {
                font-size: 0.7rem;
            }
            
            .header-logo {
                height: 50px;
            }
            
           .chart-with-details {
        flex-direction: row; /* Tetap horizontal */
        gap: 8px;
    }
    
    .chart-details {
        width: 45%;
        padding: 8px;
    }
    
    .chart-wrapper {
        width: 55%;
        height: 200px;
        min-height: 200px;
    }
    
    .detail-item {
        padding: 6px 8px;
        min-height: 35px;
    }
    
    .detail-content {
        flex-direction: column;
        align-items: flex-start;
        gap: 2px;
    }
    
    .detail-values {
        align-items: flex-start;
        width: 100%;
        padding-top: 2px;
        border-top: 1px solid #e5e7eb;
    }
    
    .detail-label {
        font-size: 0.7rem;
    }
    
    .detail-value {
        font-size: 0.75rem;
    }
    
    .detail-iuran,
    .detail-percent {
        font-size: 0.65rem;
    }
}

@media (max-width: 400px) {
    .chart-with-details {
        flex-direction: column; /* Kembali ke vertikal di layar sangat kecil */
    }
    
    .chart-details {
        width: 100%;
    }
    
    .chart-wrapper {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-section">
                <img src="medan.png" alt="Logo Kota Medan" class="header-logo">
                <img src="pemprovsu.png" alt="Logo Pemprovsu" class="header-logo">
            </div>
            <div class="header-title">
                <h1>DASHBOARD POTENSI JASA KONSTRUKSI</h1>
                <h1>KANTOR CABANG MEDAN KOTA</h1>
                <p>(Sumber data : LKPP)</p>
            </div>

            <div class="header-section">
                <img src="logo.png" alt="Logo BPJS Ketenagakerjaan" class="header-logo">    
            </div>
        </header>
        
        <div class="top-bar">
            <div class="top-bar-left">
                <span id="updateDataTimestamp"></span> 
                <span class="status-indicator status-loading" id="connectionStatus">Memuat...</span>
            </div>
            <div class="top-bar-nav">
                <a href="index.html" class="nav-button">Home</a>
                <a href="topworst.html" class="nav-button">Top & Worst</a>
            </div>
            <div class="top-bar-right" style="display: flex; align-items: center;">
                <img src="semua2.png" alt="Medan" class="header-person" style="margin-left: 5px;">
            </div>
        </div>

        <div id="dashboard" class="dashboard">
            <div class="panel summary-area summary-cards-wrapper">
                <h2>Rekap Proyek</h2> 
                <div class="summary-cards">
                    <div class="card total-projects">
                        <h3>Total Proyek</h3>
                        <div class="value" id="totalProjects">0</div>
                    </div>
                    <div class="card total-value">
                        <h3>Total Nilai Proyek</h3>
                        <div class="value currency" id="totalValue">Rp 0</div>
                    </div>
                    <div class="card avg-value">
                        <h3>Potensi Iuran</h3>
                        <div class="value currency" id="potensiValue">Rp 0</div>
                    </div>
                </div>
            </div>

            <div class="panel charts-area charts-container">
                <div class="chart-card">
                    <h3>Status Potensi (Total)</h3>
                    <div class="chart-container">
                        <div class="chart-with-details">
                            <div class="chart-wrapper">
                                <canvas id="statusChart"></canvas>
                            </div>
                            <div class="chart-details" id="statusChartDetails">
                                <h4>Rincian Status</h4>
                                <!-- Detail akan diisi oleh JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Nilai Proyek Berdasarkan Sumber Dana (Total)</h3>
                    <div class="chart-container">
                        <div class="chart-with-details">
                            <div class="chart-wrapper">
                                <canvas id="sumberDanaChart"></canvas>
                            </div>
                            <div class="chart-details" id="sumberDanaChartDetails">
                                <h4>Rincian Sumber Dana</h4>
                                <!-- Detail akan diisi oleh JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel table-area">
                <h2>Pemilik Proyek</h2>
                <div class="data-table-container"> 
                    <table class="data-table" id="mainDataTable">
                        <thead>
                            <tr>
                                <th style="min-width: 40px;">No.</th>
                                <th style="min-width: 200px;">Nama Instansi/Satker</th>
                                <th style="min-width: 80px;" class="center-text">Jumlah<br>Proyek</th>
                            </tr>
                        </thead>
                        <tbody id="mainTableBody">
                            <tr>
                                <td colspan="3" style="text-align:center;padding:20px;color:#666;">
                                <div class="loading-spinner"></div>
                                <p style="margin-top:10px;">Memuat data...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>    
        </div>
        <footer class="main-footer">
        <p class="footer-text">BPJS Ketenagakerjaan Kantor Cabang Medan Kota</p>
        </footer>
    </div>

    <script>
        let statusChart = null;
        let sumberDanaChart = null;

        const SHEET_CONFIG = {
            sheetId: "1h9NVeC4Gca7IwQkuLd3kNSqaO4xLbgCBIMQK7I26HGs",
            apiKey: "AIzaSyDDChj-Syqytv2HboLnbflQu7-u_5VAYIE",
            range: "A2:M1000"
        };

        document.addEventListener('DOMContentLoaded', async () => {
            updateCurrentDate();
            updateConnectionStatus('loading', 'Memuat data...');
            
            try {
                const data = await fetchGoogleSheetsData();
                if (data && data.length > 0) {
                    updateDashboard(data);
                    updateConnectionStatus('online', `${data.length} data berhasil dimuat`);
                
                    try {
                        const dataToStore = JSON.stringify(data);
                        if (typeof(Storage) !== "undefined") {
                            sessionStorage.setItem('projectData', dataToStore);
                        }
                    } catch (e) {
                        console.log("Note: Could not store data in session storage");
                    }
                } else {
                    console.log("⚠️ No data found");
                    updateConnectionStatus('error', 'Tidak ada data');
                }
            } catch (error) {
                console.error("❌ Error loading data:", error);
                updateConnectionStatus('error', 'Error memuat data');
                showError("Gagal memuat data dari Google Sheets. Silakan coba lagi.");
            }
            
            addRefreshButton();
        });

        async function fetchGoogleSheetsData() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_CONFIG.sheetId}/values/${SHEET_CONFIG.range}?key=${SHEET_CONFIG.apiKey}`;
            
            try {
                console.log("📡 Fetching data from Google Sheets...");
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (!result.values || result.values.length === 0) {
                    console.log("⚠️ No data found in the specified range");
                    return [];
                }
                
                const data = result.values.map((row, index) => {
                    return {
                        'NO': row[0] || (index + 1).toString(),
                        'KODE RUP': row[1] || '',
                        'KODE TENDER': row[2] || '',
                        'KODE PROYEK': row[3] || '',
                        'NAMA PROYEK': row[4] || '',
                        'NILAI PROYEK': row[5] || '0',
                        'SUMBER DANA': row[6] || 'Tidak Diketahui',
                        'NAMA PEMILIK': row[7] || 'Tidak Diketahui',
                        'NAMA INSTANSI': row[8] || 'Tidak Diketahui',
                        'NAMA PELAKSANA': row[9] || '',
                        'SUMBER POTENSI': row[10] || '',
                        'STATUS POTENSI': row[11] || 'Tidak Diketahui',
                        'TGL SPMK': row[12] || ''
                    };
                });
                
                return processData(data);
                
            } catch (error) {
                console.error("❌ Error fetching Google Sheets data:", error);
                throw error;
            }
        }

        function processData(rawData) {
            return rawData.map((row, index) => {
                const nilaiProyek = cleanCurrencyValue(row['NILAI PROYEK'] || '0');
                
                return {
                    no: row['NO'] || (index + 1).toString(),
                    kodeRup: row['KODE RUP'] || '',
                    kodeTender: row['KODE TENDER'] || '',
                    kodeProyek: row['KODE PROYEK'] || '',
                    namaProyek: row['NAMA PROYEK'] || '',
                    nilaiProyek: nilaiProyek,
                    sumberDana: row['SUMBER DANA'] || 'Tidak Diketahui',
                    namaPemilik: row['NAMA PEMILIK'] || 'Tidak Diketahui',
                    namaInstansi: row['NAMA INSTANSI'] || 'Tidak Diketahui',
                    namaPelaksana: row['NAMA PELAKSANA'] || '',
                    sumberPotensi: row['SUMBER POTENSI'] || '',
                    statusPotensi: row['STATUS POTENSI'] || 'Tidak Diketahui',
                    tglSpmk: row['TGL SPMK'] || ''
                };
            }).filter(item => item.namaProyek && item.namaProyek.trim() !== '' && item.namaProyek !== 'Tidak Diketahui');
        }

        function cleanCurrencyValue(value) {
            if (typeof value === 'number') return value;
            if (typeof value === 'string') {
                const cleaned = value.replace(/[^\d.-]/g, '');
                const parsed = parseFloat(cleaned) || 0;
                return parsed;
            }
            return 0;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function computePotensiIuran(amount){
        const tiers = [
            { cap: 100_000_000, rate: 0.0024 },
            { cap: 500_000_000, rate: 0.0019 },
            { cap: 1_000_000_000, rate: 0.0015 },
            { cap: 5_000_000_000, rate: 0.0012 },
            { cap: Infinity, rate: 0.0010 }
        ];

        let premi = 0;
        let prevCap = 0;

        for (const t of tiers){
            const usable = Math.max(0, Math.min(amount, t.cap) - prevCap);
            if (usable <= 0) { prevCap = t.cap; continue; }
            premi += usable * t.rate;
            prevCap = t.cap;
            if (prevCap >= amount) break;
        }
        return premi;
        }

        function updateDashboard(data) {
            updateSummaryCards(data);
            updateCharts(data);
            updateMainTable(data);
        }

        function updateSummaryCards(data) {
        const totalProjects = data.length;
        const totalValue = data.reduce((sum, p) => sum + (p.nilaiProyek || 0), 0);
        const potensi = computePotensiIuran(totalValue); 

        const elTotal = document.getElementById('totalProjects');
        const elTotalValue = document.getElementById('totalValue');
        const elPotensi = document.getElementById('potensiValue');

        if (elTotal) elTotal.textContent = totalProjects.toLocaleString('id-ID');
        if (elTotalValue) elTotalValue.textContent = formatCurrency(totalValue);
        if (elPotensi) elPotensi.textContent = formatCurrency(potensi);

        console.log(`📊 Summary Updated | Proyek:${totalProjects} | Nilai:${formatCurrency(totalValue)} | Potensi:${formatCurrency(potensi)}`);
        }

        function updateCharts(data) {
            updateStatusChart(data);
            updateSumberDanaChart(data);
        }

        function updateStatusChart(data) {
            if (typeof computePotensiIuran !== 'function') {
                window.computePotensiIuran = function(nilaiProyek) {
                    return Number(nilaiProyek) ? Number(nilaiProyek) * 0.00127 : 0;
                };
            }
            if (typeof formatCurrency !== 'function') {
                window.formatCurrency = function(num) {
                    return (Number(num) || 0).toLocaleString('id-ID', {
                        style: 'currency',
                        currency: 'IDR',
                        maximumFractionDigits: 0
                    }).replace(',00', '');
                };
            }

            const normalizeMapStatus = (s) => {
                const x = String(s ?? '')
                    .normalize('NFKC')
                    .trim()
                    .toUpperCase()
                    .replace(/\s+/g, ' ');

                if (
                    x === 'BELUM TL' ||
                    x === 'BELUM_TL' ||
                    x === 'BELUM-TL' ||
                    x === 'TIDAK VALID' ||
                    x === 'TIDAK_VALID' ||
                    x === 'VALID'
                ) {
                    return 'Belum Terdaftar';
                }
                if (x === 'TERDAFTAR') {
                    return 'Terdaftar';
                }

                return x.toLowerCase().replace(/\b\w/g, (c) => c.toUpperCase());
            };

            const statusCounts = {};
            const statusPotensi = {};

            (data || []).forEach((project) => {
                const statusFinal = normalizeMapStatus(project.statusPotensi);
                const nilai = Number(project.nilaiProyek) || 0;
                const pot = computePotensiIuran(nilai);

                statusCounts[statusFinal] = (statusCounts[statusFinal] || 0) + 1;
                statusPotensi[statusFinal] = (statusPotensi[statusFinal] || 0) + pot;
            });

            const colorMap = {
                'terdaftar': '#0066cc',
                'belum terdaftar': '#dc3545'
            };

            const rawLabels = Object.keys(statusCounts);
            const displayLabels = rawLabels.map((l) => l === 'Terdaftar' ? 'Terdaftar' : l);
            const values = rawLabels.map((l) => statusCounts[l] || 0);
            const colors = rawLabels.map((l) => colorMap[l.toLowerCase()] || '#6c757d');
            const potensiValues = rawLabels.map((l) => statusPotensi[l] || 0);
            const totalPotensiAll = potensiValues.reduce((a, b) => a + b, 0);

            updateStatusChartDetails(rawLabels, values, potensiValues, totalPotensiAll);

            try {
                if (window.statusChart && typeof window.statusChart.destroy === 'function') {
                    window.statusChart.destroy();
                }
            } catch (e) { /* ignore */ }
            window.statusChart = null;

            const ctx = document.getElementById('statusChart').getContext('2d');

            if (typeof ChartDataLabels !== 'undefined') {
                try {
                    Chart.register(ChartDataLabels);
                } catch (e) { /* ignore */ }
            }

            const maxValue = values.length ? Math.max(...values) : 0;
            const thresholdRelative = 0.25;

            window.statusChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: displayLabels,
                    datasets: [
                        {
                            data: values,
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: 'var(--color-surface)',
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { display: false } },
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0 }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (ctx) {
                                    const idx = ctx.dataIndex;
                                    const count = ctx.raw;
                                    const pot = potensiValues[idx] || 0;
                                    const pct = totalPotensiAll ? (pot / totalPotensiAll) * 100 : 0;

                                    return [
                                        `${displayLabels[idx]}: ${count.toLocaleString('id-ID')} proyek`,
                                        `Potensi iuran: ${formatCurrency(pot)} (${pct.toFixed(1)}%)`,
                                    ];
                                },
                            },
                        },
                        datalabels: {
                            display: true,
                            formatter: function(value, ctx) {
                                const idx = ctx.dataIndex;
                                const pot = potensiValues[idx] || 0;
                                const pct = totalPotensiAll ? (pot / totalPotensiAll) * 100 : 0;
                                return `${value.toLocaleString('id-ID')} proyek\n${formatCurrency(pot)} (${pct.toFixed(1)}%)`;
                            },
                            anchor: function(ctx) {
                                const val = ctx.dataset.data[ctx.dataIndex] || 0;
                                return val >= (maxValue * thresholdRelative) ? 'center' : 'end';
                            },
                            align: function(ctx) {
                                const val = ctx.dataset.data[ctx.dataIndex] || 0;
                                return val >= (maxValue * thresholdRelative) ? 'center' : 'start';
                            },
                            offset: function(ctx) {
                                const val = ctx.dataset.data[ctx.dataIndex] || 0;
                                return val >= (maxValue * thresholdRelative) ? 0 : -6;
                            },
                            color: function(ctx) {
                                const val = ctx.dataset.data[ctx.dataIndex] || 0;
                                return val >= (maxValue * thresholdRelative) ? '#ffffff' : '#111';
                            },
                            font: function(ctx) {
                                const val = ctx.dataset.data[ctx.dataIndex] || 0;
                                return {
                                    weight: '600',
                                    size: val >= (maxValue * thresholdRelative) ? 12 : 11,
                                };
                            },
                            backgroundColor: function(ctx) {
                                const val = ctx.dataset.data[ctx.dataIndex] || 0;
                                return val >= (maxValue * thresholdRelative) ? 'transparent' : 'rgba(255,255,255,0.9)';
                            },
                            borderRadius: 6,
                            padding: { top: 6, bottom: 6, left: 8, right: 8 },
                            lineHeight: 1.05,
                            clamp: true
                        }
                    }
                },
                plugins: (typeof ChartDataLabels !== 'undefined') ? [ChartDataLabels] : []
            });
        }

       function updateStatusChartDetails(labels, values, potensiValues, totalPotensiAll) {
  const detailsContainer = document.getElementById('statusChartDetails');
  if (!detailsContainer) {
    console.error('Element #statusChartDetails tidak ditemukan.');
    return;
  }
  detailsContainer.innerHTML = '<h4>Rincian Status</h4>';

  const normalizeLabel = (label) => {
    if (!label) return '';
    return String(label).trim().toLowerCase().replace(/[_\-]+/g, ' ').replace(/\s+/g, ' ');
  };

  const toCanonical = (label) => {
    const x = normalizeLabel(label);
    if (!x) return '';
    if (x.includes('batal')) return 'batal';
    if (x.includes('terdaftar') && !x.includes('belum')) return 'terdaftar';
    // tangani varian seperti "belum terdaftar", "belum tl", "belum_tl", "valid"/"tidak_valid" => anggap 'belum'
    if (x.includes('belum') || x.includes('valid') || x.includes('tidak valid') || x.includes('tidak_valid') || x.includes('belum tl') || x.includes('belum_tl')) return 'belum';
    return x.replace(/\s+/g, '');
  };

  // Tentukan path target (sesuaikan kalau nama file/folder berbeda)
  const targetBelumPath = '/detail-statusbelum.html'; // <-- pastikan file ini benar
  const targetOtherPath = '/detail-status.html';      // <-- dan ini juga

  labels.forEach((label, index) => {
    const count = values[index] || 0;
    const potensi = potensiValues[index] || 0;
    const pct = totalPotensiAll ? (potensi / totalPotensiAll) * 100 : 0;

    const canonical = toCanonical(label) || 'unknown';
    const normalizedLabel = normalizeLabel(label);

    const detailItem = document.createElement('div');

    let itemClass = 'detail-item';
    if (canonical === 'batal') itemClass += ' dark';
    else if (canonical === 'terdaftar') itemClass += ' blue';
    else if (canonical === 'belum') itemClass += ' red belum-terdaftar';

    detailItem.className = itemClass;
    detailItem.setAttribute('data-status', canonical);
    detailItem.style.cursor = 'pointer';

    detailItem.innerHTML = `
      <div class="detail-content">
        <span class="detail-label">${label}</span>
        <div class="detail-values">
          <span class="detail-value">${count.toLocaleString('id-ID')}</span>
          <span class="detail-iuran">${formatCurrency(potensi)}</span>
          <span class="detail-percent">${pct.toFixed(1)}%</span>
        </div>
      </div>
    `;

    detailItem.addEventListener('click', (ev) => {
      // debug log — hapus nanti kalau sudah beres
      console.log('clicked status detail:', { label, index, canonical });

      // Jika canonical 'belum' (termasuk varian 'belum terdaftar' dll) -> buka halaman khusus
      if (canonical === 'belum' || normalizedLabel === 'belum terdaftar') {
        const url = `${location.origin}${targetBelumPath}?status=${encodeURIComponent(canonical)}&label=${encodeURIComponent(label)}`;
        window.location.assign(url);
        return;
      }

      // default: buka halaman umum dan kirim status canonical
      const urlOther = `${location.origin}${targetOtherPath}?status=${encodeURIComponent(canonical)}&label=${encodeURIComponent(label)}`;
      window.location.assign(urlOther);
    });

    detailsContainer.appendChild(detailItem);
  });
}






        function updateSumberDanaChart(data) {
            const sumberDanaValues = {};
            data.forEach(project => {   
                const sumber = project.sumberDana || 'Tidak Diketahui';
                const nilai = Number(project.nilaiProyek) || 0;
                sumberDanaValues[sumber] = (sumberDanaValues[sumber] || 0) + nilai;
            });

            const labels = Object.keys(sumberDanaValues);
            const values = Object.values(sumberDanaValues);
            const totalValue = values.reduce((a, b) => a + b, 0);

            updateSumberDanaChartDetails(labels, values, totalValue);

            const baseColors = ['#004c99', '#0066cc', '#ffcc00', '#28a745', '#4BC0C0', '#ff9f40', '#dc3545', '#9966ff'];
            const colors = labels.map((_, i) => baseColors[i % baseColors.length]);

            if (sumberDanaChart) {
                sumberDanaChart.destroy();
            }

            const ctx = document.getElementById('sumberDanaChart').getContext('2d');
            sumberDanaChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Total Nilai Iuran',
                        data: values,
                        backgroundColor: colors,
                        borderColor: '#ffffff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { display: false } },
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                precision: 0,
                                callback: function(value) {
                                    if (value >= 1000000000) {
                                        return (value / 1000000000).toFixed(0) + 'B';
                                    } else if (value >= 1000000) {
                                        return (value / 1000000).toFixed(0) + 'M';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(0) + 'K';
                                    }
                                    return value;
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {display:false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const value = Number(ctx.raw) || 0;
                                    const total = ctx.dataset.data.reduce((a, b) => a + Number(b || 0), 0);
                                    const pct = total ? (value / total * 100) : 0;
                                    return `${ctx.label}: ${formatCurrency(value)} (${pct.toFixed(1)}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateSumberDanaChartDetails(labels, values, totalValue) {
            const detailsContainer = document.getElementById('sumberDanaChartDetails');
            detailsContainer.innerHTML = '<h4>Rincian Sumber Dana</h4>';
            
            labels.forEach((label, index) => {
                const value = values[index] || 0;
                const pct = totalValue ? (value / totalValue) * 100 : 0;
                
                const detailItem = document.createElement('div');
                detailItem.className = 'detail-item blue';
                
                detailItem.innerHTML = `
                    <div class="detail-content">
                        <span class="detail-label">${label}</span>
                        <div class="detail-values">
                            <span class="detail-value">${formatCurrency(value)}</span>
                            <span class="detail-percent">${pct.toFixed(1)}%</span>
                        </div>
                    </div>
                `;
                detailsContainer.appendChild(detailItem);
            });
        }

        function updateMainTable(data) {
            const instansiCounts = {};
            const instansiValues = {};
            
            data.forEach(project => {
                const instansi = project.namaInstansi || 'Tidak Diketahui';
                instansiCounts[instansi] = (instansiCounts[instansi] || 0) + 1;
                instansiValues[instansi] = (instansiValues[instansi] || 0) + project.nilaiProyek;
            });
            
            const sortedInstansi = Object.keys(instansiCounts).sort((a, b) => instansiCounts[b] - instansiCounts[a]);
            const mainTableBody = document.getElementById('mainTableBody');
            mainTableBody.innerHTML = '';
            
            sortedInstansi.forEach((instansi, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="center-text">${index + 1}</td>
                    <td>
                        <a href="detail.html?instansi=${encodeURIComponent(instansi)}" class="instansi-link" title="${instansi}">
                            ${instansi}
                        </a>
                        <div style="font-size: 0.8em; color: #666; margin-top: 2px;">
                            Total: ${formatCurrency(instansiValues[instansi])}
                        </div>
                    </td>
                    <td class="center-text">${instansiCounts[instansi]}</td>
                `;
                mainTableBody.appendChild(row);
            });
        }

        function updateCurrentDate() {
            const now = new Date();
            
            const formatter = new Intl.DateTimeFormat('id-ID', {
                day: '2-digit', 
                month: 'short',
                year: 'numeric',
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit',
                hourCycle: 'h23',
                timeZone: 'Asia/Jakarta'
            });
            
            let formatted = formatter.format(now);
            
            formatted = formatted
                .replace('Okt', 'Oct')
                .replace('Sep', 'Sep')
                .replace('Agu', 'Aug')
                .replace('Jul', 'Jul')
                .replace('Jun', 'Jun')
                .replace('Mei', 'May')
                .replace('Apr', 'Apr')
                .replace('Mar', 'Mar')
                .replace('Feb', 'Feb')
                .replace('Jan', 'Jan')
                .replace(/\./g, ':')
                .replace(/\s\s+/g, ' ');

            const finalString = `Update data per tgl. ${formatted}`;
            
            const dateElement = document.getElementById('updateDataTimestamp');
            if (dateElement) {
                dateElement.textContent = finalString;
            }
        }

        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                statusElement.className = `status-indicator status-${status}`;
                statusElement.textContent = message;
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; padding: 15px; border-radius: 8px; z-index: 10000; max-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                    <strong>Error:</strong> ${message}
                    <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; color: white; font-size: 18px; cursor: pointer; margin-left: 10px;">&times;</button>
                </div>
            `;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 5000);
        }

        function addRefreshButton() {
            const topBarRight = document.querySelector('.top-bar-right');
            if (topBarRight) {
                const refreshButton = document.createElement('button');
                refreshButton.innerHTML = '🔄 Refresh';
                refreshButton.className = 'refresh-button';
                refreshButton.style.cssText = `
                    background: var(--color-surface);
                    color: var(--color-primary);
                    border: none;
                    padding: 6px 12px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: bold;
                    font-size: 0.9em;
                    transition: all 0.3s ease;
                    margin-left: 10px;
                `;
                refreshButton.onclick = refreshData;
                refreshButton.onmouseover = function() {
                    this.style.background = '#e9eef2';
                    this.style.transform = 'translateY(-1px)';
                };
                refreshButton.onmouseout = function() {
                    this.style.background = 'var(--color-surface)';
                    this.style.transform = 'translateY(0)';
                };
                topBarRight.appendChild(refreshButton);
            }
        }

        function refreshData() {
            updateConnectionStatus('loading', 'Memuat ulang...');
            
            fetchGoogleSheetsData()
                .then(data => {
                    if (data && data.length > 0) {
                        updateDashboard(data);
                        updateConnectionStatus('online', `${data.length} data berhasil dimuat`);
                        console.log(`✅ Data refreshed successfully: ${data.length} records`);
                    } else {
                        updateConnectionStatus('error', 'Tidak ada data');
                    }
                })
                .catch(error => {
                    console.error("❌ Error refreshing data:", error);
                    updateConnectionStatus('error', 'Error memuat data');
                    showError("Gagal memperbarui data. Silakan coba lagi.");
                });
        }

        setInterval(() => {
            console.log("🔄 Auto-refreshing data...");
            refreshData();
        }, 5 * 60 * 1000);

    </script>
</body>
</html>
