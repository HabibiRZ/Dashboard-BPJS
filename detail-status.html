<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Proyek Instansi</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #004c99; /* Biru BPJS */
            --color-secondary: #0066cc; /* Biru Terang */
            --color-green: #28a745;    /* Hijau */
            --color-yellow-accent: #ffc107; /* Kuning (untuk highlight/warning) */
            --color-background: #f0f3f6; /* Abu-abu Muda */
            --color-surface: #ffffff; /* Putih */
            --color-text-dark: #333333;
            --color-text-light: #ffffff;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
            --font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --summary-col-width: clamp(260px, 22vw, 340px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--color-background);
            color: var(--color-text-dark);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 0;
            margin-bottom: 10px;
            background-color: var(--color-surface);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        header img {
            height: 50px;
            margin-right: 15px;
        }
        
        h1 {
            text-align: center;
            font-size: 2.2rem;
            color: var(--color-primary);
            font-weight: 700;
            flex-grow: 1;
        }
        
        h2 {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--color-primary);
            text-align: center;
        }

        .panel {
            background-color: var(--color-surface);
            padding: 10px;
            min-height: 360px;
            height: auto;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 15px;
        }


        .panel.data-table-container .table-wrapper {
            flex: 1;             
            max-height: none;    
            overflow: auto;     
        }

        .panel.data-table-container {
        height: calc(100vh - 160px) !important;
        display: flex !important;
        flex-direction: column !important;
        }

        .panel.data-table-container {
        height: auto !important;
        max-height: none !important;
        display: block !important;   
        }
        .panel.data-table-container .table-wrapper {
        max-height: none !important;
        overflow: visible !important;
        }

        
        .data-table-container {
        overflow: visible !important;
        }

        .data-table thead th {
        position: sticky;
        top: 0;
        z-index: 6;
        }

        .panel.data-table-container .table-wrapper {
        flex: 1 !important;
        max-height: none !important;   
        min-height: 380px !important; 
        overflow: auto !important;      
        }

        .data-table-container {
        overflow: visible !important;
        }

        .data-table tbody tr { 
        line-height: 1;
        }
        .data-table td { 
        padding-top: 10px; 
        padding-bottom: 10px; 
        }


        .data-table-container {
            overflow: visible;   
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            padding: 5px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            color: var(--color-text-light);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .card.total-projects { background-color: var(--color-green); }
        .card.total-value { background-color: var(--color-primary); }
        .card.avg-value { background-color: var(--color-secondary); }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }

        .card h3 {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .card .value {
            font-size: 2rem;
            font-weight: 700;
        }

        .card .currency {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .charts-container {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .chart-card {
            flex: 1;
            min-width: 0;
        }

        .chart-container {
            height: 300px;
        }

        /* .status-lkpp { background-color: var(--color-yellow-accent); color:#333; } */

        .table-actions {
        display: flex;  
        gap: 12px;
        justify-content: space-between;
        align-items: center;
        margin: 5px 0 6px;
        flex-wrap: wrap;
        }

        .search-input {
        display: flex;
        align-items: center;
        gap: 5px;
        background: var(--color-surface);
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 8px 12px;
        box-shadow: var(--box-shadow);
        width: clamp(240px, 50vw, 520px);
        font-weight: 600;
        }

        .search-input input {
        border: none;
        outline: none;
        width: 100%;
        font: inherit;
        color: var(--color-text-dark);
        }

        .actions-right {
        display: flex;
        align-items: center;
        gap: 14px;
        }

        .apply-filter {
        font-size: .9rem;
        color: #444;
        user-select: none;
        }

        .rows-count {
        font-size: .9rem;
        color: #666;
        background: #f3f6fb;
        border: 1px solid #e5ecf6;
        padding: 6px 10px;
        border-radius: 8px;
        }

        
        .data-table-container {
            flex: 1;
            height: auto;
            max-height: none;
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 0;
        }

        .data-table th,
        .data-table td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table th {
            background-color: var(--color-primary);
            color: var(--color-text-light);
            font-weight: 600;
            position: sticky;
            top: 0;
            white-space: nowrap;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.3px;
            padding: 12px 8px;
            min-width: 80px;
        }
        
        .data-table th.header-rup { min-width: 120px; }
        .data-table th.header-tender { min-width: 120px; }
        .data-table th.header-proyek { min-width: 120px; }
        .data-table th.header-nama { min-width: 200px; }
        .data-table th.header-nilai { min-width: 130px; }
        .data-table th.header-sumber { min-width: 100px; }
        .data-table th.header-status { min-width: 100px; }
        .data-table th.header-date { min-width: 100px; }

        .data-table-container {
            height: calc(100vh - 140px);
            overflow-y: auto;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tbody tr:hover {
            background-color: #f5f8fb;
            transition: background-color 0.2s ease;
        }

        .project-link{
            color: var(--color-primary);
            cursor: pointer;
            text-decoration: underline;
        }
        .project-link:hover{ opacity:.8; }


        .status-badge { 
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: capitalize;
            color: #fff;              /* teks putih */
            display: inline-block;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }


        

    .status-terdaftar { background-color: #2ecc71; }      /* hijau baru */
    .status-belum-terdaftar { background-color: #e74c3c; }/* merah baru */
    .status-unknown { background-color: #95a5a6; }         /* abu baru */

        /* Biar yang tak terpetakan tidak ikut merah */
        .status-unknown { background-color: #6c757d; }  

        .back-button {
            display: inline-block;
            background-color: var(--color-secondary);
            color: var(--color-text-light);
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-bottom: 20px;
        }

        .back-button:hover {
            background-color: #005aa7;
            transform: translateY(-2px);
        }

        .dashboard-top {
            display: grid;
            grid-template-columns: var(--summary-col-width) 1fr; 
            column-gap: 15px;
            align-items: start;
            margin-top: 0; 
        }

        .dashboard-top .panel{
            min-height: 0;          
            padding: 14px 16px;     
            margin-bottom: 12px;
        }  
        .dashboard-top .summary-cards{
            gap: 12px;
            grid-template-columns: repeat(auto-fit, minmax(180px, auto));
            margin-bottom: 12px;
         }
        .dashboard-top .card{ padding: 8px 12px; }
        .dashboard-top .card h3{ font-size: .85rem; margin-bottom: 6px; }
        .dashboard-top .card .value{ font-size: 1.6rem; }
        .dashboard-top .card .currency{ font-size: 1.2rem; }

        .dashboard-top .charts-row{ gap: 12px; margin-bottom: 0; }
        .dashboard-top .chart-panel{ padding: 12px; }
        .dashboard-top .chart-panel .chart-container{ height: 200px; } 

        .summary-section .panel{ padding: 14px 16px; margin-bottom: 12px; }  
        .summary-section .summary-cards{
            display: grid;
            grid-template-columns: 1fr; 
            gap: 12px;
            margin-bottom: 0;
            width: 100%;
        }
        .summary-section .card{
            background: #fff;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            width: 100%;
        }
        .summary-section .card h3{ font-size: .9rem; margin-bottom: 6px; }
        .summary-section .card .value{ font-size: 1.6rem; }
        .summary-section .card .currency{ font-size: 1.2rem; }

        
        .charts-section{ display: flex; flex-direction: column; gap: 12px; }
        .charts-section .chart-panel{ padding: 12px; }
        .charts-section .chart-container{ height: 220px; } 

        .back-button{ margin-bottom: 10px; }    
    

        .charts-section {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .data-table-container {
            height: 100%;
            min-height: 300px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .table-wrapper {
            /* max-height: calc(100vh - 220px); 
            overflow: auto;                    */
            position: relative;
        }

        .data-table {
            overflow: visible;                
            border-collapse: separate;
        }

        .data-table thead th {
            position: sticky;
            top: 0;                           
            z-index: 2;                       
            background: linear-gradient(135deg, var(--color-primary), #0056b3);
            color: var(--color-text-light);
            box-shadow: 0 2px 0 rgba(0,0,0,0.05);
        }

        .data-table th.col-no,
        .data-table td:first-child {
            position: sticky;
            left: 0;
            z-index: 1;                      
            background: #7c76764d;                 
        }

        
        .data-table thead th.col-no {
            z-index: 3;
        }

        .charts-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .chart-panel {
            flex: 1;
            background-color: var(--color-surface);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .panel.data-table-container{
            display: flex !important;
            flex-direction: column !important;
            max-height: calc(100vh - 220px) !important; 
            overflow: hidden !important;                 
            padding: 14px 16px;                          
        } 
        
        .panel.data-table-container > h2{ margin-bottom: 10px; }
        .panel.data-table-container .table-actions{
            position: sticky;
            top: 0;
            z-index: 3;
            background: var(--color-surface);
            padding: 6px 0 8px;
        }

        .panel.data-table-container .table-wrapper{
            flex: 1 1 auto !important;
            min-height: 0 !important;         
            overflow: auto !important;        
            max-height: none !important;
        }

        
        .data-table {
            width: 100%;
            table-layout: fixed; /* penting: kolom mengikuti lebar yang ditentukan */
            border-collapse: collapse;
            font-size: 0.95rem; /* sedikit kecil supaya muat */
        }
        .data-table thead th{
            position: sticky;
            top: 0;
            z-index: 2;
            background: linear-gradient(135deg, var(--color-primary), #0056b3);
            color: var(--color-text-light);
        }
        .data-table th,
        .data-table td {
            padding: 10px 8px; /* kecilkan padding */
            vertical-align: top;
            border-bottom: 1px solid rgba(0,0,0,0.06);
        }
        .data-table th.col-no,
        .data-table td:first-child{
            position: sticky;
            left: 0;
            z-index: 1;
            background: #fff;                  
        }

        /* ===== Two column layout: kiri = ringkasan+chart, kanan = tabel ===== */
        .two-column {
        display: flex;
        gap: 20px;
        align-items: flex-start;
        width: 100%;
        }

        /* Left stacked: summary di atas, chart di bawah */
        .left-panel {
        flex: 0 0 10%; /* lebar tetap kira-kira 38% */
        display: flex;
        flex-direction: column;
        gap: 20px;
        }

        /* Right: tabel mengambil sisa ruang (lebih lebar) */
        .right-panel {
        flex: 1 1 60%;
        min-width: 320px;
        }

        /* Panel umum (opsional styling) */
        .panel {
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        /* Summary cards horizontal / wrap */
       .summary-cards {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .summary-cards .card {
            background: #f9fafb;
            padding: 12px;
            border-radius: 12px;
            text-align: center;
        }

        .summary-cards .value {
            font-size: 1.4rem;
            font-weight: bold;
        }

        /* CHART STATUS POTENSI */
        .charts-section {
            background: #fff;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .chart-container {
            width: 100%;
            height: 250px; /* Sesuaikan biar seimbang dengan ringkasan */
        }

        /* KANAN: TABEL DATA PROYEK */
        .data-table-container {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        /* Chart container sizing */
        .chart-container {
        height: 260px; /* sesuaikan: lebih tinggi kalau perlu */
        width: 100%;
        }

        /* Table wrapper: biar scrollable bila lebar kolom melebihi container */
        .table-wrapper {
            overflow-x: hidden; /* sembunyikan scroll horizontal */
            width: 100%;
        }

        .col-no { width: 4%;  min-width: 40px; text-align: center; }
        .col-kode { width: 12%; min-width: 110px; } /* untuk Kode RUP / Tender / Proyek */
        .col-nama { width: 34%; min-width: 240px; } /* Nama Proyek: lebih lebar, tapi word-wrap */
        .col-namaPemilik { width: 12%; min-width: 140px; }
        .col-nilai { width: 12%; min-width: 120px; text-align: right; }
        .col-sumber { width: 10%; min-width: 100px; }
        .col-status { width: 6%; min-width: 80px; text-align: center; }

        /* buat kolom Nama Proyek bisa membungkus baris (bukan memaksa lebar) */
        .data-table td .project-link {
        display: inline-block;
        max-width: 100%;
        white-space: normal;   /* biarkan wrap */
        word-break: break-word;/* pecah kata panjang */
        line-height: 1.15;
        }

        /* jika ingin teks proyek rapi dan tidak terlalu panjang, bisa batasi baris pake line-clamp */
        /* untuk browser modern saja; hapus jika tidak ingin clamp */
        .data-table td .project-link {
        display: -webkit-box;
        /* -webkit-line-clamp: 3;   tampilkan maksimal 3 baris */   
        -webkit-box-orient: vertical;
        overflow: hidden;
        }

        /* Header putih, teks biru, batas bawah halus */
        .data-table thead th {
        background: #ffffff !important;      /* putih */
        color: #0b66b2 !important;           /* biru (sesuaikan) */
        font-weight: 700;
        text-align: left;
        padding: 10px 12px;
        border-bottom: 3px solid rgba(11,102,178,0.12);
        box-shadow: none;
        }

        /* Kalau ada rule yang membuat th jadi all-caps atau transform, override */
        .data-table thead th {
        text-transform: none !important;
        font-size: 0.95rem;
        }

        /* Jika header dibuat sticky sebelumnya, style sticky juga */
        .data-table thead th.sticky {
        position: sticky;
        top: 0;
        z-index: 5;
        background: #ffffff !important;
        }

        /* Untuk sel yang berwarna biru di body (mis status badge), biar kontras */
        .data-table thead th.col-status,
        .data-table thead th.col-no {
        text-align: center;
        }

        .data-table thead th {
        position: sticky;
        top: 0;                      /* jarak dari atas container; ubah kalau perlu */
        z-index: 50;                 /* pastikan header di atas konten */
        background: #ffffff !important; /* solid supaya isi tidak tembus */
        color: #0b66b2 !important;   /* teks header biru, sesuaikan warna kalau perlu */
        font-weight: 700;
        padding: 10px 12px;
        box-shadow: 0 1px 0 rgba(0,0,0,0.05); /* garis halus di bawah header */
        }

        /* Jika header masih berada di bawah elemen lain (mis: navbar sticky atas),
        tambahkan top: <tinggi-navbar>px; contoh top: 80px; */
        
        /* Pastikan thead tetap berada di atas saat ada background panel */
        .data-table thead th::after {
        content: "";
        display: block;
        position: absolute;
        left: 0; right: 0; bottom: -1px;
        height: 1px;
        background: rgba(0,0,0,0.06);
        }

        /* Atur lebar kolom Nama Proyek agar tidak terlalu lebar */
.data-table th.col-nama,
.data-table td:nth-child(5) {
  max-width: 320px;   /* batas lebar maksimum */
  width: 320px;       /* biar konsisten */
  white-space: normal; /* teks bisa turun ke baris berikutnya */
  word-wrap: break-word;
  overflow-wrap: break-word;
}

/* Biar teks lain tetap muat dan tabel bisa scroll horizontal */
.table-wrapper {
  overflow-x: auto;
}


/* Lebarkan kolom Kode Proyek */
.data-table th:nth-child(4),
.data-table td:nth-child(4) {
  width: 160px;       /* sebelumnya mungkin sekitar 100px */
  max-width: 160px;
  white-space: nowrap;
  text-overflow: ellipsis;
  overflow: hidden;
}

/* Lebarkan kolom Nilai Proyek */
.data-table th:nth-child(7),
.data-table td:nth-child(7) {
  width: 180px;       /* sebelumnya mungkin sekitar 130px */
  max-width: 180px;
  white-space: nowrap;
  text-align: right;  /* biar angka lebih rapi */
}

/* Kolom Nama Proyek sedikit dikecilkan agar tidak tabrakan */
.data-table th:nth-child(5),
.data-table td:nth-child(5) {
  width: 280px;
  max-width: 280px;
  word-wrap: break-word;
  white-space: normal;
}

.data-table {
  width: 100%;
  border-collapse: collapse;
  overflow-x: auto;
  display: block;
}

.data-table th,
.data-table td {
  white-space: nowrap;
  text-align: left;
  padding: 8px;
  border-bottom: 1px solid #ddd;
}

/* Header biru */
.data-table th {
  background-color: #0d47a1;
  color: white;
  font-weight: bold;
  position: sticky;
  top: 0;
  z-index: 2;
}

/* Biar isi tabel gak ketimpa */
.data-table td {
  background-color: white;
}
/* KONTEKS SCROLL: .table-wrapper harus yang scrollable */
.table-wrapper {
  max-height: 70vh;   /* atur tinggi area tabel sesuai layout */
  overflow: auto;     /* penting: membuat area scroll sehingga sticky bekerja */
  position: relative; /* konteks positioning */
}

/* Pastikan tabel bersifat table (jangan display:block) */
.data-table {
  width: 100%;
  table-layout: auto; /* atau fixed jika mau kontrol kolom */
  border-collapse: collapse;
  display: table;     /* pastikan table display default */
}

/* Sel dan header */
.data-table th,
.data-table td {
  padding: 10px 12px;
  border-bottom: 1px solid rgba(0,0,0,0.06);
  vertical-align: middle;
}

/* --- Sticky header yang aman --- */
.data-table thead th {
  position: sticky;
  top: 0;                       /* jarak dari atas .table-wrapper; ubah bila perlu */
  z-index: 100;                 /* harus lebih besar dari z-index td */
  background: #0b66b2;          /* solid supaya teks isi tidak tembus */
  color: #ffffff;               /* teks header */
  font-weight: 700;
  box-shadow: 0 2px 6px rgba(0,0,0,0.04);
}

/* Jika ada navbar/header lain yang juga sticky di atas viewport, sesuaikan top:
   contoh: top: 110px; (sesuaikan tinggi navbar/header mu) */
/* .data-table thead th { top: 110px; } */

/* Pastikan isi td berada di bawah header (z-index lebih rendah) */
.data-table tbody td {
  position: relative;
  z-index: 1;
  background: #fff; /* agar tidak terlihat tembus */
}

/* Opsional: jika kamu ingin header full-width warna putih tapi border bawah biru tipis */
.data-table thead th::after {
  content: "";
  position: absolute;
  left: 0; right: 0; bottom: 0;
  height: 2px;
  background: rgba(11,102,178,0.12);
}


.data-table th:nth-child(6),
.data-table td:nth-child(6) {
  width: 100px;
  max-width: 100px;
  word-wrap: break-word;
  white-space: normal;
}

.data-table th:nth-child(4),
.data-table td:nth-child(4) {
  width: 100px;
  max-width: 100px;
  word-wrap: break-word;
  white-space: normal;
}

.data-table th:nth-child(9),
.data-table td:nth-child(9) {
  width: 100px;
  max-width: 100px;
  word-wrap: break-word;
  white-space: normal;
}

        /* kecilkan ukuran font di layar sempit agar tetap muat */
        @media (max-width: 1200px) {
        .data-table { font-size: 0.88rem; }
        .col-nama { width: 36%; }
        .col-kode { width: 14%; }
        .col-nilai { width: 10%; }
        }

        /* pada layar sangat kecil, kita tumpuk atau aktifkan scroll (fallback) */
        @media (max-width: 700px) {
        .table-wrapper { overflow-x: auto; } /* fallback: aktifkan scroll kecil bila perlu */
        .data-table th, .data-table td { padding: 8px 6px; }
        }

        /* Responsif: tumpuk vertikal di layar kecil */
        @media (max-width: 900px) {
        .two-column {
            flex-direction: column;
        }
        .left-panel {
            flex: 1 1 auto;
        }
        .right-panel {
            flex: 1 1 auto;
        }
        .chart-container {
            height: 220px;
        }
        }


        @media (min-width: 992px) {
            .charts-container {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .panel.data-table-container{ max-height: calc(100vh - 280px) !important; }
            .dashboard-top .card .value{ font-size: 1.4rem; }
            .dashboard-top .chart-panel .chart-container{ height: 180px; }
            .summary-cards {
                grid-template-columns: 1fr;
            }
            .charts-row {
                flex-direction: column;
            }
            header img {
                height: 60px;
                margin-right: 10px;
            }
            h1 {
                font-size: 1.8rem;
            }
        }

        @media (max-width: 1200px) {
            .dashboard-top {
                flex-direction: column;
            }
        }

        @media (max-width: 1400px) {
            .dashboard-container {
                flex-direction: column;
            }
        }

        @media (min-width: 901px) {
        /* Panel utama menempel, halaman tidak ikut scroll */
        body { overflow-y: hidden !important; }
        .container {
            position: sticky !important;
            top: 10px !important;
            max-height: calc(100vh - 20px) !important;
            overflow: hidden !important;
        }

        /* Bagian atas tetap terlihat */
        .dashboard-container {
            height: calc(100vh - 200px) !important; /* sesuaikan jika header berbeda tinggi */
            overflow: hidden !important;
            display: flex !important;
            flex-direction: column !important;
            gap: 20px !important;
            align-items: flex-start;
        }

        /* Panel tabel: hanya area tabel yang scroll */
        .panel.data-table-container {
            display: flex !important;
            flex-direction: column !important;
            max-height: calc(100vh - 260px) !important; /* ruang untuk summary+chart */
            overflow: hidden !important;
        }
        .panel.data-table-container .table-wrapper {
            flex: 1 1 auto !important;
            min-height: 0 !important;
            overflow: auto !important;           /* <- scroll di sini */
            max-height: none !important;
        }

        /* Header tabel tetap nempel saat isi tabel di-scroll */
        .panel.data-table-container thead th {
            position: sticky !important;
            top: 0 !important;
            z-index: 6 !important;
        }
        }

        /* ================== HP (≤900px) ================== */
        @media (max-width: 900px) {
        /* Matikan sticky: halaman bisa scroll normal */
        body { overflow-y: auto !important; }
        .container {
            position: static !important;
            max-height: none !important;
            overflow: visible !important;
        }
        .dashboard-container {
            height: auto !important;
            overflow: visible !important;
        }

        /* Tabel tetap punya scroll sendiri agar nyaman dibaca */
        .panel.data-table-container {
            display: block !important;
            max-height: none !important;
            overflow: visible !important;
        }
        .panel.data-table-container .table-wrapper {
            max-height: 60vh !important;         /* ketinggian area scroll tabel di HP */
            overflow: auto !important;
        }

        /* Header tabel tetap sticky di dalam area tabel */
        .panel.data-table-container thead th {
            position: sticky !important;
            top: 0 !important;
            z-index: 6 !important;
        }

        /* Susunan atas jadi menumpuk */
        .dashboard-top {
            display: flex !important;
            flex-direction: column !important;
            gap: 12px !important;
        }
        .summary-cards {
            display: grid !important;
            grid-template-columns: 1fr 1fr !important;
            gap: 10px !important;
        }
        @media (max-width: 520px) {
            .summary-cards { grid-template-columns: 1fr !important; }
        }
        .charts-section .chart-container { height: 180px !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img src="medan.png" alt="Logo Kota Medan" class="header-logo">
            <img src="pemprovsu.png" alt="Logo Kota Medan" class="header-logo">
            <h1><span id="instansiTitle"></span></h1>
            <img src="logo.png" alt="Logo BPJS Ketenagakerjaan">
        </header>

        <a href="index.html" class="back-button">← Kembali ke Dashboard Utama</a>

        <!-- ===== DASHBOARD: kiri (summary+chart) | kanan (table) ===== -->
        <div class="dashboard-container">
        <div class="dashboard-top two-column">
            <!-- LEFT: Ringkasan (atas) + Chart (bawah) -->
            <div class="left-panel">
            <div class="summary-section panel">
                <div class="summary-cards">
                <div class="card total-projects" style="background-color: #28a745;">
                    <h3>Total Proyek</h3>
                    <div class="value" id="totalProjects">0</div>
                </div>
                <div class="card total-value" style="background-color:#004c99;">
                    <h3>Total Nilai Proyek</h3>
                    <div class="value currency" id="totalValue">Rp 0</div>
                </div>
                <div class="card avg-value" style="background-color: #0066cc;">
                    <h3>Potensi Iuran</h3>
                    <div class="value currency" id="potensiValue">Rp 0</div>
                </div>
                </div>
            </div>

            <!-- <div class="charts-section panel">
                <h3>Status Potensi</h3>
                <div class="chart-container">
                <canvas id="statusChart"></canvas>
                </div>
            </div> -->
            </div>

            <!-- RIGHT: Tabel data -->
            <div class="right-panel panel data-table-container">
            <h2>Data Proyek</h2>

            <div class="table-actions">
                <div class="search-input">
                🔎
                <input id="tableSearch" type="text"
                    placeholder="Cari: nama proyek, Kode RUP/Tender/Proyek, pelaksana, sumber dana, status..." />
                </div>

                <div class="actions-right">
                <label class="apply-filter">
                    <input type="checkbox" id="applyToCharts" />
                    Terapkan filter ke ringkasan & grafik
                </label>
                <span id="rowsCount" class="rows-count">Menampilkan 0 dari 0</span>
                </div>
            </div>

            <div class="table-wrapper">
                <table class="data-table" id="dataTable">
                <thead>
                    <tr>
                    <th class="col-no">No.</th>
                    <th class="col-kode">Kode RUP</th>
                    <th class="col-kode">Kode Tender</th>
                    <th class="col-kode">Kode Proyek</th>
                    <th class="col-nama">Nama Proyek</th>
                    <th class="col-namaPemilik">Nama Pelaksana Proyek</th>
                    <th class="col-nilai">Nilai Proyek</th>
                    <th class="col-sumber">Sumber Dana</th>
                    <th class="col-status">Status</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
                </table>
            </div>
            </div>
        </div>
        </div>
        </div>
    </div>

    <script>
/* -------------------------
   Helper / Config (tetap)
   ------------------------- */
let originalDetailData = [];
let searchInitialized = false;
let currentInstansi = null;
let currentStatusParam = null;

const SHEET_CONFIG = {
    sheetId: "1h9NVeC4Gca7IwQkuLd3kNSqaO4xLbgCBIMQK7I26HGs",
    apiKey: "AIzaSyDDChj-Syqytv2HboLnbflQu7-u_5VAYIE",
    range: "A2:M1000"
};

function cleanCurrencyValue(value){
    if (typeof value === 'number') return value;
    if (typeof value === 'string') {
        const cleaned = value.replace(/[^\d.-]/g, '');
        const parsed = parseFloat(cleaned) || 0;
        return parsed;
    }
    return 0;
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

/* -------------------------
   Normalisasi status (kamu sudah punya) 
   ------------------------- */
function normalizeMapStatus(s) {
  const x = String(s ?? '')
    .normalize('NFKC')
    .trim()
    .toUpperCase()
    .replace(/\s+/g, ' ');

  if (x === 'BELUM TL' || x === 'VALID' || x === 'TIDAK_VALID') {
    return 'Belum Terdaftar';
  }
  if (x === 'TERDAFTAR') {
    return 'Terdaftar';
  }
  if (x === 'BATAL' || x === 'DIBATALKAN') {
    return 'Batal';
  }

  return x.toLowerCase().replace(/\b\w/g, (c) => c.toUpperCase());
}

/* -------------------------
   Helper: map param status singkat ke label yang dipakai
   menerima: 'belum'|'terdaftar'|'batal' atau string lain
   mengembalikan: 'Belum Terdaftar'|'Terdaftar'|'Batal'|null
   ------------------------- */
function mapStatusParamToLabel(param) {
  if (!param) return null;
  const p = String(param).trim().toLowerCase();
  if (p === 'belum' || p === 'belum terdaftar' || p === 'belum_terdaftar') return 'Belum Terdaftar';
  if (p === 'terdaftar') return 'Terdaftar';
  if (p === 'batal') return 'Batal';
  // jika param sudah berupa label lengkap coba normalisasi
  return normalizeMapStatus(p);
}

/* -------------------------
   Fetch + parse Google Sheets
   ------------------------- */
async function fetchGoogleSheetsData() {
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_CONFIG.sheetId}/values/${SHEET_CONFIG.range}?key=${SHEET_CONFIG.apiKey}`;
    const response = await fetch(url);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const res = await response.json();
    if (!res.values || res.values.length === 0) return [];

    const headers = [
        'NO','KODE RUP','KODE TENDER','KODE PROYEK','NAMA PROYEK',
        'NILAI PROYEK','SUMBER DANA','NAMA PEMILIK','NAMA INSTANSI','NAMA PELAKSANA',
        'SUMBER POTENSI','STATUS POTENSI','TGL SPMK'
    ];

    const data = res.values.map((row, idx) => {
        const obj = {};
        headers.forEach((h, ci) => { obj[h] = row[ci] || ''; });
        return {
            no: obj['NO'] || (idx+1).toString(),
            kodeRup: obj['KODE RUP'] || '',
            kodeTender: obj['KODE TENDER'] || '',
            kodeProyek: obj['KODE PROYEK'] || '',
            namaProyek: obj['NAMA PROYEK'] || '',
            nilaiProyek: cleanCurrencyValue(obj['NILAI PROYEK'] || '0'),
            sumberDana: obj['SUMBER DANA'] || '',
            namaPemilik: obj['NAMA PEMILIK'] || '',
            namaInstansi: obj['NAMA INSTANSI'] || '',
            namaPelaksana: obj['NAMA PELAKSANA'] || '',
            sumberPotensi: obj['SUMBER POTENSI'] || '',
            statusPotensi: obj['STATUS POTENSI'] || '',
            tglSpmk: obj['TGL SPMK'] || ''
        };
    });

    return data.filter(d => d.namaProyek && d.namaProyek.trim() !== '');
}

/* -------------------------
   Filter utilities
   - filterByStatusLabel: dibandingkan dengan normalizeMapStatus(project.statusPotensi)
   - filterByInstansiName: case-insensitive exact match
   ------------------------- */
function filterByStatusLabel(data, statusLabel) {
  if (!statusLabel) return data.slice();
  return data.filter(p => {
    const projLabel = normalizeMapStatus(p.statusPotensi);
    return projLabel.toLowerCase() === statusLabel.toLowerCase();
  });
}

function filterByInstansiName(data, instansi) {
  if (!instansi) return data.slice();
  return data.filter(p => (p.namaInstansi || '').toLowerCase() === instansi.toLowerCase());
}

/* -------------------------
   Render Table & Summary
   ------------------------- */
function updateSummaryCards(data){
  const totalProjects = data.length;
  const totalValue = data.reduce((s,p)=>s+(p.nilaiProyek||0),0);
  // contoh potensi: pake computePotensiIuran total / bisa disesuaikan
  const potensi = computePotensiIuran(totalValue);
  const elTotal = document.getElementById('totalProjects');
  const elTotalValue = document.getElementById('totalValue');
  const elPotensi = document.getElementById('potensiValue');
  if (elTotal) elTotal.textContent = totalProjects.toLocaleString('id-ID');
  if (elTotalValue) elTotalValue.textContent = formatCurrency(totalValue);
  if (elPotensi) elPotensi.textContent = formatCurrency(potensi);
}

function updateDetailTable(data){
  originalDetailData = data.slice(); // penting: data yang tampil jadi sumber pencarian
  const tableBody = document.getElementById('tableBody');
  tableBody.innerHTML = '';
  if (!data || data.length === 0){
    tableBody.innerHTML = `<tr><td colspan="9" style="text-align:center;color:#666;padding:18px">Tidak ada data yang cocok dengan filter.</td></tr>`;
    updateRowsCount(0, 0);
    return;
  }
  data.forEach((project, idx) => {
    const statusLabel = normalizeMapStatus(project.statusPotensi);
    const bg = statusLabel === 'Terdaftar' ? '#2ecc71' :
               statusLabel === 'Belum Terdaftar' ? '#e74c3c' : '#95a5a6';
    const statusBadge = `<span class="status-badge" style="background:${bg};color:#fff;padding:8px 12px;border-radius:30px;font-weight:600">${statusLabel}</span>`;
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${idx+1}</td>
      <td>${project.kodeRup || '-'}</td>
      <td>${project.kodeTender || '-'}</td>
      <td>${project.kodeProyek || '-'}</td>
      <td>
        <div style="font-weight:600">${escapeHtml(project.namaProyek)}</div>
        <div style="font-size:.85rem;color:#666;margin-top:4px">Pelaksana: ${escapeHtml(project.namaPelaksana || 'Tidak diketahui')}</div>
      </td>
      <td>${escapeHtml(project.namaPelaksana || 'Tidak diketahui')}</td>
      <td style="font-weight:700;color:#0b6ab2">${formatCurrency(project.nilaiProyek)}</td>
      <td>${escapeHtml(project.sumberDana || '-')}</td>
      <td>${statusBadge}</td>
    `;
    tableBody.appendChild(row);
  });
  updateRowsCount(data.length, data.length);
}

/* small helpers */
function escapeHtml(t){ return String(t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function updateRowsCount(showing, total){ const el=document.getElementById('rowsCount'); if (el) el.textContent = `Menampilkan ${showing.toLocaleString('id-ID')} dari ${total.toLocaleString('id-ID')}`; }

/* -------------------------
   Search setup (pencarian di table)
   - bekerja pada originalDetailData (yang sudah difilter oleh status/instansi)
   ------------------------- */
function setupTableSearch() {
  const input = document.getElementById('tableSearch');
  const applyBox = document.getElementById('applyToCharts');
  if (!input || searchInitialized) return;
  searchInitialized = true;

  const runFilter = () => {
    const q = (input.value || '').trim().toLowerCase();
    let filtered = originalDetailData.slice();
    if (q) {
      const tokens = q.split(/\s+/);
      filtered = filtered.filter(p => {
        const hay = [
          p.kodeRup, p.kodeTender, p.kodeProyek,
          p.namaProyek, p.namaPelaksana,
          p.sumberDana, p.statusPotensi
        ].join(' ').toLowerCase();
        return tokens.every(t => hay.includes(t));
      });
    }
    updateDetailTable(filtered);
    updateRowsCount(filtered.length, originalDetailData.length);
    if (applyBox?.checked) {
      updateSummaryCards(filtered);
      updateCharts?.(filtered);
    }
  };

  input.addEventListener('input', debounce(runFilter, 200));
  applyBox?.addEventListener('change', runFilter);
}

/* -------------------------
   Debounce
   ------------------------- */
function debounce(fn, delay=300) {
  let t;
  return (...args) => { clearTimeout(t); t = setTimeout(()=>fn.apply(null,args), delay); };
}

/* -------------------------
   computePotensiIuran (tetap) 
   ------------------------- */
function computePotensiIuran(amount){
  const tiers = [
    { cap: 100_000_000, rate: 0.0024 },
    { cap: 500_000_000, rate: 0.0019 },
    { cap: 1_000_000_000, rate: 0.0015 },
    { cap: 5_000_000_000, rate: 0.0012 },
    { cap: Infinity, rate: 0.0010 }
  ];
  let premi = 0, prevCap = 0;
  for (const t of tiers){
    const usable = Math.max(0, Math.min(amount, t.cap) - prevCap);
    if (usable <= 0) { prevCap = t.cap; continue; }
    premi += usable * t.rate;
    prevCap = t.cap;
    if (prevCap >= amount) break;
  }
  return premi;
}

/* -------------------------
   Main init: baca URL params, fetch data, lalu filter (VERSI FIXED)
   ------------------------- */
document.addEventListener('DOMContentLoaded', async () => {
  const params = new URLSearchParams(window.location.search);
  currentInstansi = params.get('instansi') || null;
  currentStatusParam = params.get('status') || null;

  // Update title/heading sesuai param (tampilkan canonical jika ada)
  const canonicalStatusLabel = mapStatusParamToCanonical(currentStatusParam);
  if (currentInstansi && canonicalStatusLabel) {
    document.getElementById('instansiTitle').textContent = `Detail Proyek - ${currentInstansi} • Status: ${canonicalStatusLabel}`;
    document.title = `${currentInstansi} - ${canonicalStatusLabel}`;
  } else if (currentInstansi) {
    document.getElementById('instansiTitle').textContent = `Detail Proyek - ${currentInstansi}`;
    document.title = `${currentInstansi}`;
  } else if (canonicalStatusLabel) {
    document.getElementById('instansiTitle').textContent = `Detail Proyek - Status: ${canonicalStatusLabel}`;
    document.title = `Status: ${canonicalStatusLabel}`;
  } else {
    document.getElementById('instansiTitle').textContent = 'Detail Proyek';
  }

  try {
    showLoading(true);
    const allData = await fetchGoogleSheetsData();

    if (!allData || allData.length === 0) {
      showError("Tidak ada data dari Google Sheets.");
      return;
    }

    // lakukan filter: prioritas = both (instansi+status) -> instansi -> status -> semua
    let filtered = allData.slice();

    if (currentInstansi) {
      filtered = filterByInstansiName(filtered, currentInstansi);
    }

    // GUNAKAN canonical filter (pastikan ini menggantikan pemanggilan lama)
    if (currentStatusParam) {
      filtered = filterByStatusCanonical(filtered, currentStatusParam);
    }

    // Debugging opsional — uncomment jika perlu lihat apa yang sedang disaring:
    // console.log('DEBUG: currentStatusParam=', currentStatusParam, 'canonical=', mapStatusParamToCanonical(currentStatusParam));
    // console.log('DEBUG: filtered count after status filter=', filtered.length);

    updateSummaryCards(filtered);
    updateDetailTable(filtered);
    setupTableSearch(); // search akan bekerja pada originalDetailData (yang sekarang = filtered)

  } catch (err) {
    console.error("Error init:", err);
    showError("Gagal memuat data. Cek console untuk detail.");
  } finally {
    showLoading(false);
  }
});


/* -------------------------
   Click handler nama proyek (tetap)
   ------------------------- */
document.getElementById('tableBody')?.addEventListener('click', (e) => {
  const anchor = e.target.closest('.project-link');
  if (!anchor) return;
  const nama = decodeURIComponent(anchor.dataset.proyek || '');
  const subset = originalDetailData.filter(p => (p.namaProyek||'').toLowerCase() === nama.toLowerCase());
  updateSummaryCards(subset);
  if (document.getElementById('applyToCharts')?.checked) updateCharts?.(subset);
  document.getElementById('rowsCount').textContent = `Menampilkan ${subset.length.toLocaleString('id-ID')} dari ${originalDetailData.length.toLocaleString('id-ID')} • Filter ringkasan: ${nama}`;
});

/* -------------------------
   showLoading & showError (tetap, jika sudah ada gunakan yang ada)
   ------------------------- */
function showLoading(show) {
    let loader = document.getElementById('loadingIndicator');
    if (show) {
        if (!loader) {
            loader = document.createElement('div');
            loader.id = 'loadingIndicator';
            loader.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.35); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="border: 4px solid #f3f3f3; border-top: 4px solid #004c99; border-radius: 50%; width: 36px; height: 36px; animation: spin 1s linear infinite; margin: 0 auto 8px;"></div>
                        <div style="font-size:.95rem">Memuat data...</div>
                    </div>
                </div>
                <style>@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>
            `;
            document.body.appendChild(loader);
        }
        loader.style.display = 'block';
    } else if (loader) {
        loader.style.display = 'none';
    }
}

function showError(message){
    const errorDiv = document.createElement('div');
    errorDiv.innerHTML = `<div style="position:fixed;top:20px;right:20px;background:#dc3545;color:white;padding:12px;border-radius:8px;z-index:10000;max-width:320px">${message}<button onclick="this.parentElement.parentElement.remove()" style="float:right;background:none;border:none;color:white;font-size:18px;cursor:pointer">&times;</button></div>`;
    document.body.appendChild(errorDiv);
    setTimeout(()=>{ if (errorDiv.parentElement) errorDiv.remove(); }, 5000);
}

// Map status param -> canonical key
function mapStatusParamToCanonical(param) {
    if (!param) return null;
    const p = String(param).toLowerCase().trim();
    if (p === 'belum' || p === 'belum terdaftar' || p === 'belum_terdaftar') return 'belum';
    if (p === 'terdaftar') return 'terdaftar';
    if (p === 'batal') return 'batal';
    if (p.includes('belum')) return 'belum';
    if (p.includes('terdaftar')) return 'terdaftar';
    if (p.includes('batal')) return 'batal';
    return null;
}


// Ambil canonical key dari nilai status di tiap project (normalisasi)
function projectStatusToCanonical(project) {
    const raw = String(project.statusPotensi || '').toLowerCase();
    if (raw.includes('batal') || raw.includes('dibat')) return 'batal';
    if (raw.includes('terdaftar')) return 'terdaftar';
    if (raw.includes('belum') || raw.includes('valid') || raw.includes('tidak_valid') || raw.includes('belum tl')) return 'belum';
    return raw.replace(/\s+/g,'');
}

// Filter menggunakan canonical equality (lebih ketat)
function filterByStatusCanonical(data, statusParam) {
    const target = mapStatusParamToCanonical(statusParam);
    if (!target) return data.slice();
    return data.filter(p => projectStatusToCanonical(p) === target);
}

// contoh di init
const params = new URLSearchParams(window.location.search);
const statusParam = params.get('status') || null;

// ... fetch data jadi `allData`
let filtered = allData.slice();
if (statusParam) {
    filtered = filterByStatusCanonical(filtered, statusParam);
}

console.log('Received statusParam=', currentStatusParam, 'canonical=', mapStatusParamToCanonical(currentStatusParam));
allData.slice(0,10).forEach(p => console.log(p.namaProyek, '->', projectStatusToCanonical(p)));



</script>

</body>
</html>